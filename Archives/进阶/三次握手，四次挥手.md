#### 相关文章

[详解TCP连接的三次握手和四次挥手](https://www.cnblogs.com/AhuntSun-blog/p/12028636.html)

[两张动图彻底明白TCP的三次握手和四次挥手](https://blog.csdn.net/qzcsu/article/details/72861891)

### 常见问题

**1.为什么TCP客户端最后还要确认一次**

主要防止已经失效的连接请求报文突然又传送到了服务器，从而产生错误。

如果使用的是两次握手建立连接，假设有这样一种场景，客户端发送了第一个请求连接并且没有丢失，只是因为在网络结点中滞留的时间太长了，由于TCP的客户端迟迟没有收到确认报文，以为服务器没有收到，此时重新向服务器发送这条报文，此后客户端和服务器经过两次握手完成连接，传输数据，然后关闭连接。此时此前滞留的那一次请求连接，网络通畅了到达了服务器，这个报文本该是失效的，但是，两次握手的机制将会让客户端和服务器再次建立连接，这将导致不必要的错误和资源的浪费。

如果采用的是三次握手，就算是那一次失效的报文传送过来了，服务端接受到了那条失效报文并且回复了确认报文，但是客户端不会再次发出确认。由于服务器收不到确认，就知道客户端并没有请求连接。

**2.为什么建立连接是三次握手，关闭连接确是四次挥手呢？**

建立连接的时候， 服务器在LISTEN状态下，收到建立连接请求的SYN报文后，把ACK和SYN放在一个报文里发送给客户端。
而关闭连接时，服务器收到对方的FIN报文时，仅仅表示对方不再发送数据了但是还能接收数据，而自己也未必全部数据都发送给对方了，所以己方可以立即关闭，也可以发送一些数据给对方后，再发送FIN报文给对方来表示同意现在关闭连接，因此，己方ACK和FIN一般都会分开发送，从而导致多了一次。

`灵性举例`

三次握手:男向女求婚，男生先说“我爱你...”`seq=x`，女生答复“我愿意...”`seq=y`,并伸出了右手`ACK=x+1`，男生给女生戴上戒指`ACK=Y+1`，求婚过程完毕，这时候男生(客户端)->女生(服务器)，少一次指定是不行的。

四次挥手:女向男提出分手`seq=x+2`，并表示已经怀上了别人的孩子`ACk=y+1`，男生知道后，冷静思考片刻，删了联系方式`ACK=x+3`，并告知要互删`seq=y+1`，而后女生收到互删要求后,删除男生联系方式`ACK=y+2`，双方分手流程完毕,这时候女生(客户端)->男生(服务器)，流程少一次分手肯定是不彻底的。

**3.如果已经建立了连接，但是客户端秃然出现故障了怎么办**

TCP还设有一个保活计时器，显然，客户端如果出现故障，服务器不能一直等下去，白白浪费资源。服务器每收到一次客户端的请求后都会重新复位这个计时器，时间通常是设置为2小时，若两小时还没有收到客户端的任何数据，服务器就会发送一个探测报文段，以后每隔75秒发送一次。若一连发送10个探测报文仍然没反应，服务器就认为客户端出了故障，接着就关闭连接。

**4.为什么不是两次？**

 根本原因：无法确认客户端的接收能力。 可能出现的问题是，两次握手，服务端只要接收到然后发送相应的数据包，就 `默认连接 `了 ，但是事实上现在客户端可能已经断开连接了，这样也就带来了连接资源的浪费 

